<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piano CRM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8; }
    header { background: #222; color: #fff; padding: 15px; display: flex; align-items: center; }
    header img { height: 40px; margin-right: 15px; }
    h1 { font-size: 20px; margin: 0; }
    main { padding: 20px; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    button { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .filter-panel { background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f0f0f0; }
    tr:hover { background: #f9f9f9; }
    .expandable { cursor: pointer; }
    .hidden { display: none; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 400px; max-height: 80vh; overflow-y: auto; }
    .modal-content h2 { margin-top: 0; }
    .form-group { margin-bottom: 10px; }
    label { display: block; font-size: 14px; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 7px; border: 1px solid #ccc; border-radius: 5px; }
    .section-title { margin-top: 30px; font-size: 18px; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo">
  <h1>Piano Gallery CRM</h1>
</header>

<main>
  <div class="controls">
    <button onclick="toggleAddClient()">+ Add Client</button>
    <button onclick="toggleFilters()">Filters</button>
  </div>

  <div id="filterPanel" class="filter-panel">
    <div class="form-group">
      <label for="filterOwner">Lead Owner</label>
      <select id="filterOwner">
        <option value="">All</option>
        <option value="Ethan">Ethan</option>
        <option value="Tristan">Tristan</option>
        <option value="Dan">Dan</option>
        <option value="Josh">Josh</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label for="filterStatus">Status</label>
      <select id="filterStatus">
        <option value="">All</option>
        <option value="New Lead">New Lead</option>
        <option value="Working Deal">Working Deal</option>
        <option value="Closed">Closed</option>
      </select>
    </div>
    <div class="form-group">
      <label for="filterDate">Last Contact After</label>
      <input type="date" id="filterDate">
    </div>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <h2>Active Leads</h2>
  <table id="clientTable">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Piano</th>
        <th>Last Contacted</th>
        <th>Owner</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 class="section-title">Closed Leads</h2>
  <table id="closedTable">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Closing Amount</th>
        <th>Delivery Date</th>
        <th>Delivery Address</th>
        <th>Steps</th>
        <th>Owner</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- Add/Edit Modal -->
<div id="clientModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">Add Client</h2>
    <div class="form-group"><label>Name</label><input id="clientName"></div>
    <div class="form-group"><label>Phone</label><input id="clientPhone"></div>
    <div class="form-group"><label>Email</label><input id="clientEmail"></div>
    <div class="form-group"><label>Piano</label><input id="clientPiano"></div>
    <div class="form-group"><label>Last Contacted</label><input type="date" id="clientContacted"></div>
    <div class="form-group"><label>Owner</label>
      <select id="clientOwner">
        <option value="Ethan">Ethan</option>
        <option value="Tristan">Tristan</option>
        <option value="Dan">Dan</option>
        <option value="Josh">Josh</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group"><label>Status</label>
      <select id="clientStatus" onchange="toggleClosedFields()">
        <option value="New Lead">New Lead</option>
        <option value="Working Deal">Working Deal</option>
        <option value="Closed">Closed</option>
      </select>
    </div>
    <div id="closedFields" class="hidden">
      <div class="form-group"><label>Closing Amount</label><input type="number" id="closingAmount"></div>
      <div class="form-group"><label>Delivery Address</label><textarea id="deliveryAddress"></textarea></div>
      <div class="form-group"><label>Steps</label><input type="number" id="deliverySteps"></div>
      <div class="form-group"><label>Delivery Date</label><input type="date" id="deliveryDate"></div>
    </div>
    <button onclick="saveClient()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
  let editIndex = null;

  function loadClients() {
    let clients = JSON.parse(localStorage.getItem("clients")) || [];
    let oldLeads = JSON.parse(localStorage.getItem("crmLeads")) || [];
    if (oldLeads.length && !clients.length) {
      clients = oldLeads;
      localStorage.setItem("clients", JSON.stringify(clients));
    }
    let closedClients = JSON.parse(localStorage.getItem("closedClients")) || [];
    renderClients(clients);
    renderClosedClients(closedClients);
  }

  function renderClients(clients) {
    const tbody = document.querySelector("#clientTable tbody");
    tbody.innerHTML = "";
    clients.forEach((c, i) => {
      if (c.status !== "Closed") {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="expandable" onclick="toggleDetails(this)">➕</td>
          <td>${c.name || ""}</td>
          <td>${c.phone || ""}</td>
          <td>${c.email || ""}</td>
          <td>${c.piano || ""}</td>
          <td>${c.lastContacted || ""}</td>
          <td>${c.owner || ""}</td>
          <td>${c.status || "New Lead"}</td>
          <td><button onclick="editClient(${i})">Edit</button></td>
        `;
        tbody.appendChild(row);

        const detailsRow = document.createElement("tr");
        detailsRow.classList.add("hidden");
        detailsRow.innerHTML = `<td colspan="9">
          <strong>Notes:</strong> ${c.notes || "N/A"}
        </td>`;
        tbody.appendChild(detailsRow);
      }
    });
  }

  function renderClosedClients(clients) {
    const tbody = document.querySelector("#closedTable tbody");
    tbody.innerHTML = "";
    clients.forEach(c => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>✔️</td>
        <td>${c.name || ""}</td>
        <td>${c.closingAmount || ""}</td>
        <td>${c.deliveryDate || ""}</td>
        <td>${c.deliveryAddress || ""}</td>
        <td>${c.deliverySteps || ""}</td>
        <td>${c.owner || ""}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function toggleAddClient() {
    editIndex = null;
    document.getElementById("modalTitle").innerText = "Add Client";
    document.querySelectorAll("#clientModal input, #clientModal textarea, #clientModal select").forEach(e => e.value = "");
    document.getElementById("closedFields").classList.add("hidden");
    document.getElementById("clientStatus").value = "New Lead";
    document.getElementById("clientOwner").value = "Ethan";
    document.getElementById("clientModal").style.display = "flex";
  }

  function editClient(index) {
    const clients = JSON.parse(localStorage.getItem("clients")) || [];
    const c = clients[index];
    editIndex = index;
    document.getElementById("modalTitle").innerText = "Edit Client";
    document.getElementById("clientName").value = c.name || "";
    document.getElementById("clientPhone").value = c.phone || "";
    document.getElementById("clientEmail").value = c.email || "";
    document.getElementById("clientPiano").value = c.piano || "";
    document.getElementById("clientContacted").value = c.lastContacted || "";
    document.getElementById("clientOwner").value = c.owner || "Ethan";
    document.getElementById("clientStatus").value = c.status || "New Lead";
    if (c.status === "Closed") {
      document.getElementById("closingAmount").value = c.closingAmount || "";
      document.getElementById("deliveryAddress").value = c.deliveryAddress || "";
      document.getElementById("deliverySteps").value = c.deliverySteps || "";
      document.getElementById("deliveryDate").value = c.deliveryDate || "";
      document.getElementById("closedFields").classList.remove("hidden");
    } else {
      document.getElementById("closedFields").classList.add("hidden");
    }
    document.getElementById("clientModal").style.display = "flex";
  }

  function saveClient() {
    let clients = JSON.parse(localStorage.getItem("clients")) || [];
    let closedClients = JSON.parse(localStorage.getItem("closedClients")) || [];
    const client = {
      name: document.getElementById("clientName").value,
      phone: document.getElementById("clientPhone").value,
      email: document.getElementById("clientEmail").value,
      piano: document.getElementById("clientPiano").value,
      lastContacted: document.getElementById("clientContacted").value,
      owner: document.getElementById("clientOwner").value,
      status: document.getElementById("clientStatus").value,
      notes: "",
    };

    if (client.status === "Closed") {
      client.closingAmount = document.getElementById("closingAmount").value;
      client.deliveryAddress = document.getElementById("deliveryAddress").value;
      client.deliverySteps = document.getElementById("deliverySteps").value;
      client.deliveryDate = document.getElementById("deliveryDate").value;
      closedClients.push(client);
      localStorage.setItem("closedClients", JSON.stringify(closedClients));
      if (editIndex !== null) clients.splice(editIndex, 1);
    } else {
      if (editIndex !== null) clients[editIndex] = client;
      else clients.push(client);
    }

    localStorage.setItem("clients", JSON.stringify(clients));
    closeModal();
    loadClients();
  }

  function closeModal() {
    document.getElementById("clientModal").style.display = "none";
  }

  function toggleClosedFields() {
    const status = document.getElementById("clientStatus").value;
    document.getElementById("closedFields").classList.toggle("hidden", status !== "Closed");
  }

  function toggleFilters() {
    const panel = document.getElementById("filterPanel");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  }

  function applyFilters() {
    let clients = JSON.parse(localStorage.getItem("clients")) || [];
    const owner = document.getElementById("filterOwner").value;
    const status = document.getElementById("filterStatus").value;
    const date = document.getElementById("filterDate").value;

    clients = clients.filter(c => {
      return (!owner || c.owner === owner) &&
             (!status || c.status === status) &&
             (!date || (c.lastContacted && c.lastContacted >= date));
    });
    renderClients(clients);
  }

  function toggleDetails(cell) {
    const detailsRow = cell.parentElement.nextElementSibling;
    detailsRow.classList.toggle("hidden");
    cell.innerText = detailsRow.classList.contains("hidden") ? "➕" : "➖";
  }

  loadClients();
</script>
</body>
</html>
